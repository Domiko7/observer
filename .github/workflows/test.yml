name: Test build

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**"

jobs:
  build_web:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "latest"

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build web
        working-directory: web/src
        run: |
          npm install
          npm run build
          tar -zcf ../web_dist.tar.gz ../dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/web_dist.tar.gz

  test_build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target_id:
          - android_arm64_v8a
          - darwin_amd64
          - darwin_arm64_v8a
          - freebsd_386
          - freebsd_amd64
          - freebsd_arm32_v5
          - freebsd_arm32_v6
          - freebsd_arm32_v7a
          - freebsd_arm64_v8a
          - linux_386
          - linux_amd64
          - linux_arm32_v5
          - linux_arm32_v6
          - linux_arm32_v7a
          - linux_arm64_v8a
          - linux_loong64
          - linux_mips
          - linux_mips_softfloat
          - linux_mips64
          - linux_mips64_softfloat
          - linux_mips64le
          - linux_mips64le_softfloat
          - linux_mipsle
          - linux_mipsle_softfloat
          - linux_ppc64le
          - linux_riscv64
          - linux_s390x
          - openbsd_386
          - openbsd_amd64
          - openbsd_arm32_v5
          - openbsd_arm32_v6
          - openbsd_arm32_v7a
          - openbsd_arm64_v8a
          - windows_386
          - windows_amd64
          - windows_arm32_v5
          - windows_arm32_v6
          - windows_arm32_v7a
          - windows_arm64_v8a
          - windows7_386
          - windows7_amd64
      fail-fast: false

    needs:
      - build_web

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Golang
        uses: actions/setup-go@v5
        with:
          cache: false
          go-version: ${{ env.TOOLCHAIN }}
          check-latest: true

      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: web

      - name: Extract web artifacts
        working-directory: web
        run: |
          tar -zxf web_dist.tar.gz
          rm -f web_dist.tar.gz

      - name: Set up workflow env
        run: |
          TOOLCHAIN=$(jq ".[\"${{ matrix.target_id }}\"].toolchain" -r < pkg/uniarch/arch_map.json)
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          GOOS=$(jq ".[\"${{ matrix.target_id }}\"].goos" -r < pkg/uniarch/arch_map.json)
          echo "GOOS=$GOOS" >> $GITHUB_ENV
          GOARCH=$(jq ".[\"${{ matrix.target_id }}\"].goarch" -r < pkg/uniarch/arch_map.json)
          echo "GOARCH=$GOARCH" >> $GITHUB_ENV
          GOARM=$(jq ".[\"${{ matrix.target_id }}\"].goarm" -r < pkg/uniarch/arch_map.json)
          echo "GOARM=$GOARM" >> $GITHUB_ENV
          GOMIPS=$(jq ".[\"${{ matrix.target_id }}\"].gomips" -r < pkg/uniarch/arch_map.json)
          echo "GOMIPS=$GOMIPS" >> $GITHUB_ENV

      - name: Build core application
        run: |
          GOOS=${{ env.GOOS }} \
          GOARCH=${{ env.GOARCH }} \
          GOARM=${{ env.GOARM }} \
          GOMIPS=${{ env.GOMIPS }} \
          BUILD_PLATFORM=github-actions-ci \
          make build
